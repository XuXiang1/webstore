<!doctype html>
<html lang='en'>

	<head>
		<meta charset='UTF-8'>
		<meta name="viewport" content="user-scalable=no" />
		<title>Wow Talk</title>
		<link rel='stylesheet' href='./css/reset.css'>
		<link rel='stylesheet' href='./css/style.css'>

		<script src="./scripts/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="./scripts/nw-desktop-notifications.js"></script>
		<script src="./scripts/lang.js" type="text/javascript" charset="utf-8"></script>
		<script src="./scripts/main.js" type="text/javascript" charset="utf-8"></script>
	</head>

	<body>
		<header>
			<ul>
				<li>
					<a href='javascript:void(0)' title='Options' id='windowControlOption'></a>
				</li>
				<li>
					<a href='javascript:void(0)' title='Minimize' id='windowControlMinimize'></a>
				</li>
				<!--<li>
					<a href='#' title='Maximize' id='windowControlMaximize'></a>
				</li>-->
				<li>
					<a href='javascript:void(0)' title='Close' id='windowControlClose'></a>
				</li>
			</ul>
		</header>

		<div class="list-group hidediv" id="option_menu">
			<!--active-->
			<a href="javascript:void(0)" onclick="showNotion()" class="list-group-item active-option">
				<img id="show_notion_img" src="./img/option-1.png" />
			</a>
			<a href="javascript:void(0)" onclick="is_checkUpdate()" class="list-group-item ">
				<img id="is_checkUpdate_img" src="./img/option-1.png" />
			</a>
			<a href="javascript:void(0)" onclick="quit_exc()" class="list-group-item">
				<img id="quitexe" src="./img/option-1.png" style="visibility: hidden;" />
			</a>

			<script>
				$("#show_notion_img").after(language_broswer['news_popup']);
				$("#is_checkUpdate_img").after(language_broswer['check_pudate']);
				$("#quitexe").after(language_broswer['exit_program']);
			</script>
		</div>
		<!--<div id="load" align="center">

			<img src="loading.gif" />

		</div>-->
		<!-- 首先放一个div，用做loading效果 -->
		<div class="update-pannel" id="holder">
			<div class="title-content" style="display: none;">
				<div class="clogo">
					<div id="version"></div>
				</div>
				<div id="status_log"></div>
				<div class="update-content " style="display: none;">
					<ul type="disc" id="new_feacture">
						<!--<li class="li-title">图库</li>
						<li class="li-item">新增已同步照片只删除本地不删除云功能</li>-->
					</ul>
					<!--进度条-->
					<div id="loaded" style="height: 40px;"></div>
					<div class="progress" style="display: none;">
						<div class="progress-bar progress-bar-striped active" id="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0;">
							0%
						</div>
					</div>
					<!--按钮-->
					<div class="btn-content">
						<button class="btn btn-primary right" id="skip_now" onclick="goto_page()" style="margin-right: 61px;"></button>
						<button class="btn btn-success right" id="update_now" style="margin-right: 12px;"></button>

						<script>
							$("#update_now").html(language_broswer['update_now']);
							$("#skip_now").html(language_broswer['skip_now']);
						</script>
					</div>
				</div>

			</div>

		</div>

		<div class="main">
			<iframe src="" id="iframepage" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" style="display: none;"></iframe>
		</div>

		<script type="text/javascript">
			//main_page.init();
			var nw = require('nw.gui');
			var winparent = nw.Window.get();
			nw.App.on('open', function() {
				winparent.show();
			});
			//窗口默认不最大化
			winparent.isMaximized = false;
			var isShowWindow = true;
			var pkg = require('./manifest.json');
			var request = require('request');
			var url = require('url');
			var path = require('path');
			var os = require('os');
			var fs = require('fs');
			var k = 0;
			var updater = require('node-webkit-updater');
			var upd = new updater(pkg);
			var timeout;
			var menu_right = new nw.Menu;
			$("#iframepage").attr("src", pkg.main_url_to);
			tray_init();
			resizeframe();
			window_resize_init();
			$(window).bind('resize', resizeframe);
			//页面初始化动作
			//接收消息初始化
			window.addEventListener('message', function(e) {
				try {
					var jsonstr = e.data;
					var jsonobj = JSON.parse(jsonstr);
					if (jsonobj[0] == "show_window") {
						winparent.show();
					} else if (jsonobj[0] == "link") {
						if (jsonobj[1] != undefined && jsonobj[1] != "" && jsonobj[1] != "#" && jsonobj[1].indexOf('javascript') == -1) {
							nw.Shell.openExternal(jsonobj[1]);
						} else {
							return false;
						}

					} else if (jsonobj[0] == "capture_desktop") {
						captureDeskTop();
					} else if (jsonobj[0] == "right_click") {
						menu_right.popup(jsonobj[1], jsonobj[2]);
					} else {
						if (is_show_notion == "true") {
							showFunnyNotification(jsonobj[0], jsonobj[1]);
						}
					}
				} catch (e) {}
			}, false);
			$(function() {
				resizeframe();
				set_config_init();//菜单设置
				right_menue_init();//右键菜单
				setTimeout(function() {
					nw.Window.get().show();
					if (is_check_update == "true") {
						check_update();
					} else {
						goto_page();
					}
				}, 100);

			});

			function right_menue_init() {

				menu_right.append(new nw.MenuItem({
					label: language_broswer['cut'],
					click: function() {
						var jsonstr = JSON.stringify(['commond', 'cut']);
						post_msg(jsonstr)
					}
				}));

				menu_right.append(new nw.MenuItem({
					label: language_broswer['copy'],
					click: function() {
						var jsonstr = JSON.stringify(['commond', 'copy']);
						post_msg(jsonstr)
					}
				}));

				menu_right.append(new nw.MenuItem({
					label: language_broswer['paste'],
					click: function() {
						var jsonstr = JSON.stringify(['commond', 'paste']);
						post_msg(jsonstr)
					}
				}));
			}

			function post_msg(jsonstr) {
				var frm = document.getElementById("iframepage");
				frm.contentWindow.postMessage(jsonstr, "*")
			}
			//检查更新
			function check_update() {
				upd.checkNewVersion(versionChecked);
			}

			function newAppInstalled(err) {
				if (err) {
					status_log_(err);
					goto_page();
					return;
				}
				upd.run(execPath, null);
				nw.App.quit();
			}

			function versionChecked(err, newVersionExists, manifest) {
				if (err) {
					//status_log_(err);
					goto_page();
					return Error(err);
				} else if (!newVersionExists) {
					//status_log_(language_broswer['no_new_version']);
					goto_page();
					return;
				}
				$(".title-content").show();
				//检测到新版本
				//显示新特性
				status_log_(language_broswer['checking_version']);
				document.getElementById('version').innerHTML = 'V ' + pkg.version;
				//				var newfeactures = [];
				//				switch (language_broswer['test_language']) {
				//					case "en":
				//						newfeactures = manifest["description_english"];
				//						break;
				//					case "zh":
				//						newfeactures = manifest["description_chinese"];
				//						break;
				//					default:
				//						newfeactures = manifest["description_japanese"];
				//						break;
				//				}
				//				$("#new_feacture").html("");
				//				for (var i = 0; i < newfeactures.length; i++) {
				//					if (i % 2 == 0) {
				//						$("#new_feacture").append($("<li></li>").addClass("li-title").html(newfeactures[i]));
				//					} else {
				//						$("#new_feacture").append($("<li></li>").addClass("li-item").html(newfeactures[i]));
				//					}
				//				}
				$(".update-content").show();
				var loaded = 0;
				status_log_(language_broswer['new_version_detected'] + " V" + manifest.version);
				//检查大版本号
				var current_num = pkg.version.split('.')[0];
				var server_num = manifest.version.split('.')[0];
				if (server_num > current_num) {
					//立刻更新，无需点击
					$("#update_now").hide();
					$("#skip_now").hide();
					var newVersion = upd.download(function(error, filename) {
						newVersionDownloaded(error, filename, manifest);
					}, manifest);
					//滚动条1231
					$("#loaded").css("height", "17px");
					$(".progress").show();
					newVersion.on('data', function(chunk) {
						loaded += chunk.length;
						var percent1 = Math.floor(loaded / newVersion['content-length'] * 100);
						var target_my = $("#progress-bar");
						target_my.css("width", percent1 + '%');
						target_my[0].innerHTML = percent1 + '%';
						target_my.attr("aria-valuenow", percent1);
						document.getElementById('loaded').innerHTML = language_broswer['new_version_loading'] + percent1 + '%';
					})
				} else {
					//点击立即更新
					$("#update_now").click(function() {
						$("#update_now").attr("disabled", "disabled");
						var newVersion = upd.download(function(error, filename) {
							newVersionDownloaded(error, filename, manifest);
						}, manifest);
						//滚动条
						$("#loaded").css("height", "17px");
						$(".progress").show();
						newVersion.on('data', function(chunk) {
							loaded += chunk.length;
							var percent1 = Math.floor(loaded / newVersion['content-length'] * 100);
							var target_my = $("#progress-bar");
							target_my.css("width", percent1 + '%');
							target_my[0].innerHTML = percent1 + '%';
							target_my.attr("aria-valuenow", percent1);
							document.getElementById('loaded').innerHTML = language_broswer['new_version_loading'] + percent1 + '%';
						})
					});
				}
			}

			function newVersionDownloaded(err, filename, manifest) {
				if (err) {
					status_log_(err);
					//检查更新出错
					goto_page();
					return Error(err);
				}
				document.getElementById('loaded').innerHTML = language_broswer['unpacking'] + filename;
				upd.unpack(filename, newVersionUnpacked, manifest);
			}

			function newVersionUnpacked(err, newAppPath) {
				if (err) {
					status_log_(err);
					goto_page();
					return Error(err);
				}
				var runner = upd.runInstaller(newAppPath, [upd.getAppPath(), upd.getAppExec()]);
				nw.App.quit();
			}

			function status_log_(msg) {
				$("#status_log").html(msg);
			}
			//
			//自动改变iframe大小
			function resizeframe() {
				var new_height = $(".main").height() - 30 - 1;
				$("#iframepage").css("height", new_height + "px");
				var new_width = $(".main").width() - 1;
				$("#iframepage").css("width", new_width + "px");
			}
			//点击事件注册
			function window_resize_init() {
				// Options
				document.getElementById('windowControlOption').onclick = function() {
					showHideMenu();
				}; // Options
				$("#windowControlOption").blur(function() {
					clearTimeout(timeout);
					timeout = setTimeout(hideMenu, 200);
				});
				$("#option_menu").click(function() {
					clearTimeout(timeout);
					$("#windowControlOption").focus();
				});

				//选择选项
				// Min
				document.getElementById('windowControlMinimize').onclick = function() {
					winparent.minimize();
				}; // Close
				document.getElementById('windowControlClose').onclick = function() {
					winparent.close();
				}; // Max
				//				document.getElementById('windowControlMaximize').onclick = function() {
				//					if (winparent.isMaximized) {
				//						//						winparent.width = 900;
				//						//						winparent.height = 700;
				//						//						winparent.isMaximized = false;
				//						winparent.unmaximize();
				//					} else {
				//						winparent.maximize();
				//					}
				//				};
				winparent.on('maximize', function() {
					winparent.isMaximized = true;
				});
				winparent.on('unmaximize', function() {
					winparent.isMaximized = false;
				});
			}
			//系统设置
			function showHideMenu() {
				$("#option_menu").toggleClass("hidediv");
			}

			function hideMenu() {
				$("#option_menu").addClass("hidediv");
			}
			//是否显示通知
			function showNotion() {
				//通知
				var t = is_show_notion == "true" ? "false" : "true";
				set_options_setconfig("is_show_notion", t);
			}
			//是否检查更新
			function is_checkUpdate() {
				var t = is_check_update == "true" ? "false" : "true";
				set_options_setconfig("is_check_update", t);
			}

			function set_options_setconfig(option_key, t) {
				$.setconfig(option_key, t);
			}

			function check_options() {
				var isShowNotification = is_show_notion;
				//通知
				if (isShowNotification == "true") {
					$("#show_notion_img").css("visibility", "visible");
				} else {
					$("#show_notion_img").css("visibility", "hidden");
				}
				var ischeckupdate = is_check_update;
				//更新
				if (ischeckupdate == "true") {
					$("#is_checkUpdate_img").css("visibility", "visible");
				} else {
					$("#is_checkUpdate_img").css("visibility", "hidden");
				}
			}
			//显示通知
			function showFunnyNotification(title, content) {
				var icon = './img/desktop-notify.png';
				window.LOCAL_NW.desktopNotifications.notify(icon, title, content, function() {
					//window.frames[0].postMessage('getcolor','http://webtalk.com');
					winparent.show();
				});
			}
			//系统任务栏设定
			function tray_init() {
				//程序最小化到任务栏设置
				var tray = new nw.Tray({
					title: 'Wow Talk',
					icon: 'src/img/icon_36.png'
				});
				tray.tooltip = 'Wow Talk';
				//Menu
				var menu = new nw.Menu();
				menu.append(new nw.MenuItem({
					type: 'normal',
					label: language_broswer['show_hide'],
					click: function() {
						if (isShowWindow) {
							winparent.hide();
							isShowWindow = false;
						} else {
							winparent.show();
							isShowWindow = true;
						}
					},
				}));
				menu.append(new nw.MenuItem({
					type: 'normal',
					label: language_broswer['quit'],
					click: function() {
						nw.App.quit();
					}
				}))

				tray.menu = menu;
				//Click to show/hide;
				tray.on('click',
					function() {
						if (isShowWindow) {
							winparent.hide();
							isShowWindow = false;
						} else {
							winparent.show();
							isShowWindow = true;
						}
					});
				tray.on('dblclick', function() {
					if (isShowWindow) {
						winparent.hide();
						isShowWindow = false;
					} else {
						winparent.show();
						isShowWindow = true;
					}
				});
				//Close window to hide;
				winparent.on('close', function() {
					this.hide();
					isShowWindow = false;
				});
			}

			function quit_exc() {
				nw.App.quit();
			}

			function goto_page() {
				$(".update-pannel").fadeOut("fast");
				$("#iframepage").show();

			}

			function captureDeskTop() {
				var childwin = nw.Window.open('createpicture.html', {
					frame: false,
					toolbar: false,
					width: 0,
					height: 0,
					'always-on-top': true,
					show: false,
					resizable: false
				});
				childwin.on('loaded', function() {
					childwin.window.haveParent(winparent);
				});
			}

			function yesgotit() {
				var frm = document.getElementById("iframepage");
				var rootpath = path.dirname(process.execPath);
				var filename = "imagecat.png"
					//发送截图路径
				var jsonobj = [];
				jsonobj.push('upload_desktop_img');
				jsonobj.push(rootpath);
				jsonobj.push(filename);
				jsonstr = JSON.stringify(jsonobj);
				//frm.contentWindow.postMessage(jsonstr, "*")
				//var r = request.post("http://webtalk.com/drop_file_to_server");
				//var upload = fs.createReadStream(filepath + '\\' + filename)
				console.log(rootpath);
				//				var form = r.form();
				//				form.append('file', upload);
				//				upload.on("end", function(res) {
				//					//upload finished
				//					console.log(res);
				//
				//				})
			}
		</script>
		<script src="./scripts/jquery.setconfig.js" type="text/javascript" charset="utf-8"></script>
	</body>

</html>
<!doctype html>
<html lang='en'>

	<head>
		<meta charset='UTF-8'>
		<title></title>
		<script src="./scripts/jquery.min.js" type="text/javascript" charset="utf-8"></script>
	</head>

	<body>
		<video id="video" style="display: none;"></video>
		<canvas onselectstart="return false;" width="500" height="500" style="cursor: default;display: none;" id="canvas"></canvas>
		<img id="cropTestImg" src="" style="display: none;" />
		<script type="text/javascript" charset="utf-8">
			//取得video
			var mygui = require('nw.gui');
			mygui.Screen.Init();
			var dcm = mygui.Screen.DesktopCaptureMonitor;
			dcm.start(true, false);

			function haveParent(theParent) {
				//			   theParent.window.yesgotit();
				parentwindow = theParent;
			}
			dcm.on("added", function(streamId, name, order, type) {
				navigator.webkitGetUserMedia({
						audio: false,
						video: {
							mandatory: {
								chromeMediaSource: 'desktop',
								chromeMediaSourceId: streamId,
								maxWidth: 1920,
								maxHeight: 1080
							},
							optional: []
						}
					},
					function(stream) {
						// set stream of source of video element
						var video = document.querySelector('video');
						video.src = window.URL.createObjectURL(stream);
						video.onloadedmetadata = function(e) {
							//video画面画到canvas
							var video = document.querySelector('video');
							var videoWidth = video.videoWidth,
								videoHeight = video.videoHeight;
							var canvas = document.getElementById('canvas');
							canvas.width = videoWidth;
							canvas.height = videoHeight;
							canvas.getContext('2d').drawImage(
								video, 0, 0, videoWidth, videoHeight
							);
							fs = require('fs');

							// string generated by canvas.toDataURL()
							var img = $('#canvas')[0].toDataURL();
							// strip off the data: url prefix to get just the base64-encoded bytes
							var data = img.replace(/^data:image\/\w+;base64,/, "");
							var buf = new Buffer(data, 'base64');
							fs.writeFile('image.png', buf);
							//关闭视频流
							video.pause();
							video.src = null;
							stream.stop();
							var screenwidth = screen.width;
							var screenheight = screen.height;
							//弹出全屏截图窗口
							var mainwin = mygui.Window.get();
							var childwin = mygui.Window.open(
								'cutpicture.html', {
									frame: false,
									toolbar: false,
									width: screenwidth,
									height: screenheight,
									position: "center",
									'always-on-top': true,
									fullscreen:true,
									show: false,
									resizable: false
								});
							childwin.on('loaded', function() {
								childwin.window.haveParent(mainwin);
							});

						};
					},
					function(err) {
						console.log(err);
					});
				dcm.stop();
			});

			function yesgotit() {
				parentwindow.window.yesgotit();
				window.close();
			}
		</script>

	</body>

</html>